openapi: 3.0.3
info:
  title: ViralAPI
  description: |
    ViralAPI 提供高质量的 AI 图像生成服务，采用异步任务处理模式。

    ## 可用模型

    | 模型 | 别名 | 特点 |
    |------|------|------|
    | NanoBanana | `gemini-2.5-flash-image` | 快速高效，适合批量生成 |
    | NanoBanana Pro | `gemini-3-pro-image-preview` | 高质量，支持 1K/2K/4K 分辨率 |

    ## 工作流程

    1. **创建任务** — 调用 `POST /v1/task/create`，获取 `task_id`
    2. **轮询查询** — 调用 `GET /v1/task/query?task_id=xxx` 查询状态
    3. **获取结果** — 当 `status` 为 `completed` 时，从 `results` 数组获取图片 URL

    ## 认证

    所有请求需要在 Header 中携带 Bearer Token：
    ```
    Authorization: Bearer YOUR_API_KEY
    ```
    获取 API Key：[ViralAPI 控制台](https://viralapi.ai/api-key)
  version: 1.0.0
  contact:
    name: ViralAPI Support
    url: https://viralapi.ai/api-key

servers:
  - url: https://viralapi.ai
    description: Production server

security:
  - BearerAuth: []

tags:
  - name: NanoBanana
    description: |
      NanoBanana（模型：`gemini-2.5-flash-image`）— 快速高效的图像生成模型。
      支持文生图和图像编辑两种模式。
  - name: NanoBanana Pro
    description: |
      NanoBanana Pro（模型：`gemini-3-pro-image-preview`）— 高质量图像生成模型。
      支持文生图和图像编辑，额外支持 1K/2K/4K 分辨率选择。
  - name: Task Query
    description: 异步任务状态查询

paths:
  /v1/task/create:
    post:
      tags:
        - NanoBanana
        - NanoBanana Pro
      summary: Create Image Task
      description: |
        创建异步图像生成或编辑任务，返回 `task_id` 用于后续查询。

        通过 `model` 参数选择模型，通过 `input.image_urls` 区分文生图与图像编辑：
        - **文生图**：仅提供 `prompt`（和可选的 `aspect_ratio` / `image_size`）
        - **图像编辑**：同时提供 `prompt` 和 `image_urls`

        ### 模型选择

        | 模型名称 | 用途 | 额外参数 |
        |----------|------|----------|
        | `gemini-2.5-flash-image` | 快速生成 | `aspect_ratio` |
        | `gemini-3-pro-image-preview` | 高质量生成 | `aspect_ratio`, `image_size` |
      operationId: createTask
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateTaskRequest'
            examples:
              nanobanana-text-to-image:
                summary: NanoBanana 文生图
                description: 使用 gemini-2.5-flash-image 模型进行文本到图像生成
                value:
                  model: gemini-2.5-flash-image
                  task_type: image
                  input:
                    prompt: "A serene mountain landscape at sunset with vibrant colors"
                    aspect_ratio: "16:9"
              nanobanana-image-edit:
                summary: NanoBanana 图像编辑
                description: 使用 gemini-2.5-flash-image 模型基于参考图进行编辑
                value:
                  model: gemini-2.5-flash-image
                  task_type: image
                  input:
                    prompt: "Transform this into a watercolor painting style"
                    image_urls:
                      - "https://example.com/input-image.jpg"
                    aspect_ratio: "1:1"
              nanobanana-pro-text-to-image:
                summary: NanoBanana Pro 文生图
                description: 使用 gemini-3-pro-image-preview 模型进行高质量文本到图像生成
                value:
                  model: gemini-3-pro-image-preview
                  task_type: image
                  input:
                    prompt: "A futuristic banana with neon lights in a cyberpunk city"
                    image_size: "2K"
                    aspect_ratio: "9:16"
              nanobanana-pro-image-edit:
                summary: NanoBanana Pro 图像编辑
                description: 使用 gemini-3-pro-image-preview 模型进行高质量图像编辑
                value:
                  model: gemini-3-pro-image-preview
                  task_type: image
                  input:
                    prompt: "Transform this into a cyberpunk style with neon lights"
                    image_urls:
                      - "https://example.com/input-image.jpg"
                    image_size: "2K"
                    aspect_ratio: "9:16"
      responses:
        "200":
          description: 任务创建成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreateTaskResponse'
              examples:
                nanobanana-success:
                  summary: NanoBanana 任务创建成功
                  value:
                    code: 200
                    msg: success
                    data:
                      task_id: "task_nanobanana_1765178625768"
                nanobanana-pro-success:
                  summary: NanoBanana Pro 任务创建成功
                  value:
                    code: 200
                    msg: success
                    data:
                      task_id: "task_nano-banana-pro_1765178625768"
        "400":
          description: 请求参数错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error:
                  code: 400
                  message: "Invalid request parameters: 'prompt' is required"
                  type: invalid_request_error
                  param: input.prompt
        "401":
          description: 认证失败 — Token 缺失或无效
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error:
                  code: 401
                  message: "Invalid or expired token"
                  type: authentication_error
        "402":
          description: 余额不足
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error:
                  code: 402
                  message: "Insufficient account balance. Please top up at https://viralapi.ai/api-key"
                  type: payment_required
        "403":
          description: 权限不足 — 无权访问该模型
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error:
                  code: 403
                  message: "Access denied for this model"
                  type: permission_error
                  param: model
        "404":
          description: 模型不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error:
                  code: 404
                  message: "Specified model not found"
                  type: not_found_error
                  param: model
                  fallback_suggestion: "gemini-2.5-flash-image"
        "500":
          description: 服务器内部错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error:
                  code: 500
                  message: "Internal server error, please try again later"
                  type: server_error
        "502":
          description: 网关错误 — 上游服务暂时不可用
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error:
                  code: 502
                  message: "Gateway error, server temporarily unavailable"
                  type: bad_gateway
                  fallback_suggestion: "retry after 30 seconds"

  /v1/task/query:
    get:
      tags:
        - Task Query
      summary: Query Task Status
      description: |
        根据 `task_id` 查询异步任务的执行状态和结果。

        ### 任务状态流转

        ```
        pending → processing → completed
                             → failed
        ```

        ### 轮询建议

        - 建议轮询间隔：2-5 秒
        - 任务超时时间：取决于模型和图像复杂度
        - 当 `status` 为 `completed` 或 `failed` 时停止轮询
      operationId: queryTask
      security:
        - BearerAuth: []
      parameters:
        - name: task_id
          in: query
          required: true
          description: 任务 ID（从 `POST /v1/task/create` 返回的 `data.task_id`）
          schema:
            type: string
            example: "task_nano-banana-pro_1765178625768"
      responses:
        "200":
          description: 查询成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TaskStatusResponse'
              examples:
                completed:
                  summary: 任务完成 — 可从 results 获取图片
                  value:
                    create_time: 1756817821
                    complete_time: 1763088308
                    task_type: image
                    task_id: "task_nano-banana-pro_1765178625768"
                    progress: 100
                    model: "gemini-3-pro-image-preview"
                    status: completed
                    results:
                      - "https://cdn.viralapi.ai/outputs/generated-image-1.png"
                processing:
                  summary: 任务处理中
                  value:
                    create_time: 1756817821
                    complete_time: 0
                    task_type: image
                    task_id: "task_nano-banana-pro_1765178625768"
                    progress: 45
                    model: "gemini-3-pro-image-preview"
                    status: processing
                    results: []
                pending:
                  summary: 任务等待中（排队）
                  value:
                    create_time: 1756817821
                    complete_time: 0
                    task_type: image
                    task_id: "task_nano-banana-pro_1765178625768"
                    progress: 0
                    model: "gemini-3-pro-image-preview"
                    status: pending
                    results: []
                failed:
                  summary: 任务失败
                  value:
                    create_time: 1756817821
                    complete_time: 1763088308
                    task_type: image
                    task_id: "task_nano-banana-pro_1765178625768"
                    progress: 0
                    model: "gemini-3-pro-image-preview"
                    status: failed
                    results: []
        "400":
          description: 无效的 task_id 格式
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error:
                  code: 400
                  message: "Invalid task ID format"
                  type: invalid_request_error
                  param: task_id
        "401":
          description: 认证失败
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error:
                  code: 401
                  message: "Invalid authentication credentials"
                  type: authentication_error
        "402":
          description: 余额不足
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error:
                  code: 402
                  message: "Insufficient balance. Please top up your account"
                  type: payment_required
        "403":
          description: 权限不足
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error:
                  code: 403
                  message: "Access forbidden. You don't have permission to access this resource"
                  type: permission_error
        "404":
          description: 任务不存在或已过期
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error:
                  code: 404
                  message: "Task not found or expired"
                  type: not_found_error
                  param: task_id
        "500":
          description: 服务器内部错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error:
                  code: 500
                  message: "Internal server error"
                  type: server_error
                  fallback_suggestion: "retry after 30 seconds"
        "502":
          description: 上游服务错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error:
                  code: 502
                  message: "Upstream service error"
                  type: upstream_error
                  fallback_suggestion: "retry after 30 seconds"
        "503":
          description: 服务暂时不可用
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error:
                  code: 503
                  message: "Service temporarily unavailable"
                  type: service_unavailable_error
                  fallback_suggestion: "retry after 60 seconds"

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        使用 Bearer Token 进行认证。

        在请求 Header 中添加：
        ```
        Authorization: Bearer YOUR_API_KEY
        ```

        获取 API Key：[ViralAPI 控制台](https://viralapi.ai/api-key)

  schemas:
    CreateTaskRequest:
      type: object
      required:
        - model
        - task_type
        - input
      properties:
        model:
          type: string
          description: |
            模型名称，决定生成质量和速度：
            - `gemini-2.5-flash-image` — NanoBanana（快速）
            - `gemini-3-pro-image-preview` — NanoBanana Pro（高质量）
          enum:
            - gemini-2.5-flash-image
            - gemini-3-pro-image-preview
          example: "gemini-2.5-flash-image"
        task_type:
          type: string
          description: 任务类型，当前仅支持 `image`
          enum:
            - image
          example: "image"
        input:
          $ref: '#/components/schemas/TaskInput'

    TaskInput:
      type: object
      required:
        - prompt
      description: 任务输入参数
      properties:
        prompt:
          type: string
          description: 图像生成/编辑的提示词
          minLength: 1
          maxLength: 4096
          example: "A serene mountain landscape at sunset with vibrant colors"
        image_urls:
          type: array
          description: |
            输入图像的 URL 数组（用于图像编辑模式）。
            提供此参数时为图像编辑模式，不提供时为文生图模式。
            最多支持 10 张图片。
          items:
            type: string
            format: uri
          minItems: 1
          maxItems: 10
          example:
            - "https://example.com/input-image.jpg"
        image_size:
          type: string
          description: |
            输出图像分辨率（仅 `gemini-3-pro-image-preview` 模型支持）。
            - `1K` — 1024px（默认）
            - `2K` — 2048px
            - `4K` — 4096px
          default: "1K"
          enum:
            - "1K"
            - "2K"
            - "4K"
          example: "1K"
        aspect_ratio:
          type: string
          description: 输出图像宽高比
          default: "auto"
          enum:
            - "auto"
            - "1:1"
            - "2:3"
            - "3:2"
            - "3:4"
            - "4:3"
            - "4:5"
            - "5:4"
            - "9:16"
            - "16:9"
            - "21:9"
          example: "16:9"

    CreateTaskResponse:
      type: object
      required:
        - code
        - msg
        - data
      properties:
        code:
          type: integer
          description: 业务状态码
          enum:
            - 200
          example: 200
        msg:
          type: string
          description: 状态消息
          example: "success"
        data:
          type: object
          required:
            - task_id
          properties:
            task_id:
              type: string
              description: |
                异步任务 ID，用于后续调用 `GET /v1/task/query` 查询状态。
                格式为 `task_{model-prefix}_{timestamp}`
              example: "task_nanobanana_1765178625768"

    TaskStatusResponse:
      type: object
      required:
        - create_time
        - complete_time
        - task_type
        - task_id
        - progress
        - model
        - status
        - results
      properties:
        create_time:
          type: integer
          format: int64
          description: 任务创建时间（Unix 时间戳，秒）
          example: 1756817821
        complete_time:
          type: integer
          format: int64
          description: 任务完成时间（Unix 时间戳，秒）。未完成时为 `0`
          example: 1763088308
        task_type:
          type: string
          description: 任务类型
          enum:
            - image
          example: "image"
        task_id:
          type: string
          description: 任务 ID
          example: "task_nano-banana-pro_1765178625768"
        progress:
          type: integer
          description: 任务进度百分比
          minimum: 0
          maximum: 100
          example: 100
        model:
          type: string
          description: 使用的模型名称
          enum:
            - gemini-2.5-flash-image
            - gemini-3-pro-image-preview
          example: "gemini-3-pro-image-preview"
        status:
          type: string
          description: |
            任务当前状态：
            - `pending` — 排队等待处理
            - `processing` — 正在生成图像
            - `completed` — 生成完成，可获取结果
            - `failed` — 生成失败
          enum:
            - pending
            - processing
            - completed
            - failed
          example: "completed"
        results:
          type: array
          description: |
            生成的图片 URL 数组。
            仅当 `status` 为 `completed` 时包含有效 URL，否则为空数组。
            图片链接有效期为 24 小时，请及时下载保存。
          items:
            type: string
            format: uri
          example:
            - "https://cdn.viralapi.ai/outputs/generated-image-1.png"

    ErrorResponse:
      type: object
      required:
        - error
      properties:
        error:
          type: object
          required:
            - code
            - message
            - type
          properties:
            code:
              type: integer
              description: HTTP 状态码
              example: 400
            message:
              type: string
              description: 人类可读的错误描述
              example: "Invalid request parameters"
            type:
              type: string
              description: 机器可读的错误类型标识
              enum:
                - invalid_request_error
                - authentication_error
                - payment_required
                - permission_error
                - not_found_error
                - server_error
                - bad_gateway
                - upstream_error
                - service_unavailable_error
              example: "invalid_request_error"
            param:
              type: string
              description: 导致错误的参数名称（可选）
              example: "input.prompt"
            fallback_suggestion:
              type: string
              description: 建议的替代方案或重试策略（可选）
              example: "retry after 30 seconds"
